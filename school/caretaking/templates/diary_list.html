{% extends "base.html" %}

{% block breadcrumbs %}
<nav aria-label="breadcrumb">
  <ol class="breadcrumb">
      <li class="breadcrumb-item">
          <a href="/">home</a>
      </li>
      <li class="breadcrumb-item">
          <a href="{% url 'caretaking' %}">caretaking</a>
      </li>
      <li class="breadcrumb-item active">
          <a href="{% url 'staff-detail' member.user.username %}">{{ member.user.username }}</a>
      </li>
      <li class="breadcrumb-item active" aria-current="page">
          diary
      </li>
  </ol>
</nav>
{% endblock %}

{% block content %}
  {% if user.is_authenticated %}
      {% ifequal user staff.user %}
        <div class="float-right">
            <a href="{% url 'diary-add' member.user.username %}" class="action">
            <i class="fa fa-plus-circle"></i>
            <span class="sr-only">Add day to dairy<span>
            </a>
        </div>
    {% endifequal %}
  {% endif %}
    <h2>Diary: {{ member }}</h2>
    <!-- info box -->
    <div class="alert alert-info" role="alert">
        <p>
        Showing <strong>{{ days }}</strong> days between 
        <strong>{{ start_date|date:"j N Y" }}</strong> and 
        <strong>{{ end_date|date:"j N Y" }}</strong>.
        </p>
        <p>
        Use the form below to change
        the date range.
        </p>

        <form action="." method="get">
        <!-- date range options -->
        <div class="input-group" style="width: 75%">
            <input class="form-control" type="date" required name="start-date"
                value="{{ start_date|date:"Y-m-d"}}" id="start-date"
                min="" max="{{ today|date:"Y-m-d" }}">
            <input class="form-control" type="date" required name="end-date"
                value="{{ end_date|date:"Y-m-d"}}" id="end-date"
                min="" max="{{ today|date:"Y-m-d" }}">
            <div class="input-group-append">
                <button class="btn btn-secondary" type="submit">Go</button>
            </div>
        </div>

        <p class="mt-2">
        Search in the selected range:
        </p>

        <div class="input-group" style="width: 75%">
            <input class="form-control" type="text" placeholder="Search"
                onclick="$('#clear-button').removeClass('d-none');"
                id="search-term" name="q" value="{{ search_phrase }}">
            <div class="input-group-append">
                <button class="btn btn-outline{% if not search_phrase %} d-none{% endif %}"
                    type="button" id="clear-button"
                    onclick="$('#search-term').val('');"
                    >Clear</button>
                <button class="btn btn-secondary" type="submit">Go</button>
            </div>
        </div>
        {% if search_count %}
            <p>
                <strong>{{ search_count }}</strong> task{{ search_count|pluralize }} found matching search 
            phrase <strong>{{ search_phrase }}</strong>.
            </p>
        {% endif %}
            
        </form>

        <p class="mb-0 mt-1"><strong>{{ days_worked }} days</strong> (<strong>{{ total_hours }} hours</strong>) worked
        and <strong>{{ total_tasks }} tasks</strong> completed.
        </p>
    </div>
    <!-- end info box -->

    <img width="100%" src="{{ wordcloud }}" class="mb-3 mt-2">

    {% include 'snippet_pagination.html' %}

    <!-- list of days -->
    <ul class="diary-list list-unstyled">
        {% for day in diary %}
        <li{% if day.hours == -1 %} class="sr-only"{% endif %}>

            {% ifequal staff member %}
                <a href="{{ day.get_edit_url }}"
                    class="action small mt-2">
                <i class="fa fa-pencil-alt"></i>
                <span class="sr-only">Edit diary entry<span>
                </a>
            {% endifequal %}

            {{ day.total_hours }}

                <a href="{{ day.get_absolute_url }}">{{ day.day|date:"D j N Y" }}</a> 
                <span>({{ day.hours }} hrs)</span>
                {% if day.comment %}
                    <p><em>{{ day.comment }}</em></p>
                {% endif %}
                {% if day.tasks.count %}
                    <div class="task-list">
                        <ul class="task-list">
                        {% for task in day.tasks %}
                            <li>
                                <a href="{{ task.get_absolute_url }}">{{ task.description }}</a>
                            </li>
                        {% endfor %}
                        </ul>
                    </div>
                {% endif %}
            </li>
        {% endfor %}
    </ul>

    {% include 'snippet_pagination.html' %}

    {% block extra_js %}
    {% if search_count %}
    <script>
        $(document).ready(function() {
            var search_terms = "{{ search_words }}".split(' ');
            console.log(search_terms);
            search_terms.forEach(function(search_term) {
                $('ul.task-list>li').each(function() {
                    t = $(this).html();
                    console.log(t + 'term: ' + search_term);
                    if (t.indexOf(search_term) > -1) {
                        res = t.replace(search_term, 
                                '<strong class="bg-warning">' + search_term + '</strong>');
                        $(this).html(res);
                    }
                });
            });
        });
    </script>
    {% endif %}
    {% endblock extra_js %}
{% endblock %}
